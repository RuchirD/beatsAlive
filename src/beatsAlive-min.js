function loadSong(e){audio&&audio.remove(),sourceNode&&sourceNode.disconnect(),audio=new Audio,audio.src=e,audio.volume=document.getElementById("vol").value,audio.addEventListener("canplay",function(e){setupAudioNodes()},!1)}function initEQFilters(){equalizer80Hz=context.createBiquadFilter(),equalizer80Hz.type="peaking",equalizer80Hz.gain.value=0,equalizer80Hz.Q.value=1,equalizer80Hz.frequency.value=80,equalizer240Hz=context.createBiquadFilter(),equalizer240Hz.type="peaking",equalizer240Hz.gain.value=0,equalizer240Hz.Q.value=1,equalizer240Hz.frequency.value=240,equalizer750Hz=context.createBiquadFilter(),equalizer750Hz.type="peaking",equalizer750Hz.gain.value=0,equalizer750Hz.Q.value=1,equalizer750Hz.frequency.value=750,equalizer2200Hz=context.createBiquadFilter(),equalizer2200Hz.type="peaking",equalizer2200Hz.gain.value=0,equalizer2200Hz.Q.value=1,equalizer2200Hz.frequency.value=2200,equalizer6000Hz=context.createBiquadFilter(),equalizer6000Hz.type="peaking",equalizer6000Hz.gain.value=0,equalizer6000Hz.Q.value=1,equalizer6000Hz.frequency.value=6e3,eqInitiated=!0}function setupAudioNodes(){analyser=analyser||context.createAnalyser(),source=context.createBufferSource(),analyser.smoothingTimeConstant=.8,analyser.fftSize=512,gainNode=context.createGain(),gainNode.gain.value=1;try{sourceNode=context.createMediaElementSource(audio)}catch(e){return}0==eqInitiated&&initEQFilters(),sourceNode.connect(gainNode),gainNode.connect(equalizer80Hz),equalizer80Hz.connect(equalizer240Hz),equalizer240Hz.connect(equalizer750Hz),equalizer750Hz.connect(equalizer2200Hz),equalizer2200Hz.connect(equalizer6000Hz),equalizer6000Hz.connect(context.destination),sourceNode.connect(analyser),sourceNode.connect(context.destination),audio.play(),document.getElementById("play").classList.add("focus"),createSpectrum()}function createSpectrum(){document.getElementById("rectSVG")&&document.getElementById("rectSVG").parentNode.removeChild(document.getElementById("rectSVG")),rectSVG=d3.select("body").append("svg").attr("width","150%").attr("height","40%").attr("id","rectSVG");for(var e=[],t=0;t<256;t++)e[e.length]=0;var a=rectSVG.selectAll("rect").data(e);a.enter().append("rect").attr("y",100).attr("x",function(e,t){return 40*t}).attr("height",function(e,t){return e}).attr("width",20).style("fill","steelblue"),a.exit().remove(),document.getElementById("progress").setAttribute("max",audio.duration),drawSpectrum(),progressTimer=setInterval("trackChange();",100)}function getArrayAndFillSVG(e){var t=new Uint8Array(analyser.frequencyBinCount);if(analyser.getByteFrequencyData(t),0==e)for(var a=0;a<256;a++)t[a]=0;rectSVG.selectAll("rect").data(t).transition().duration(0).attr("y",100).attr("x",function(e,t){return 20*t}).attr("height",function(e,t){return.75*e}).attr("width",13).style("fill",function(e,t){return t<20?"url(#red)":t<40?"url(#yellow)":t<60?"url(#blue)":t<80?"url(#pink)":"url(#grad2)"})}function drawSpectrum(){if(audio.currentTime>=audio.duration){if(playList[indexPlaying+1])return getArrayAndFillSVG(0),void playAudio();if(1!=repeat)return clearInterval(progressTimer),audioOver=!0,void getArrayAndFillSVG(0);getArrayAndFillSVG(0),indexPlaying=-1,playAudio()}audioOver=!1,getArrayAndFillSVG(),requestAnimId=requestAnimationFrame(drawSpectrum)}function volumeChange(e){audio.volume=document.getElementById("vol").value}function highPass(e){1==document.getElementById("highPassCheck").checked?(highPassFilter=context.createBiquadFilter(),sourceNode.connect(highPassFilter),highPassFilter.connect(context.destination),highPassFilter.type=0,highPassFilter.frequency.value=800):highPassFilter.disconnect(0)}function lowPass(e){1==document.getElementById("lowPassCheck").checked?(lowPassFilter=context.createBiquadFilter(),sourceNode.connect(lowPassFilter),lowPassFilter.connect(context.destination),lowPassFilter.type=1,lowPassFilter.frequency.value=1200):lowPassFilter.disconnect(0)}function gainChange(){gainFilter&&gainFilter.disconnect(0),gainFilter=context.createBiquadFilter(),gainFilter.type=3,gainFilter.frequency.value=440,gainFilter.gain.value=document.getElementById("gain").value,sourceNode.connect(gainFilter),gainFilter.connect(context.destination)}function toggleMute(){audio&&(0==audio.volume?(audio.volume=storedVol,document.getElementById("volumeIcon").src="Images/Volume.png",document.getElementById("vol").style.opacity=1,document.getElementById("vol").removeAttribute("disabled")):(storedVol=audio.volume,audio.volume=0,document.getElementById("volumeIcon").src="Images/mute.png",document.getElementById("vol").style.opacity=.4,document.getElementById("vol").setAttribute("disabled","disabled")))}function toggleRepeat(){1==repeat?(repeat=!1,document.getElementById("repeatIcon").src="Images/repeatOff.png"):(repeat=!0,document.getElementById("repeatIcon").src="Images/repeat.png")}function trackChange(){document.getElementById("progress").value=audio.currentTime,document.getElementById("progressTime").innerHTML=audio.currentTime.toString().getFormattedTime()+"/"+audio.duration.toString().getFormattedTime()}function progressChange(){clearInterval(progressTimer),audio.currentTime=document.getElementById("progress").value,progressTimer=setInterval("trackChange();",100)}function audioChange(e){var t=e.files;if(t.length>0){var a=window.URL.createObjectURL(t[0]);document.getElementById("rectSVG")&&document.getElementById("rectSVG").parentNode.removeChild(document.getElementById("rectSVG")),document.getElementById("trackNameValue").innerHTML="::: Now Playing ::: "+t[0].name,loadSong(a),document.getElementsByClassName("focus")[0].classList.remove("focus")}}function removeFromPlayList(){var e=document.getElementsByClassName("songItemFocused");if(e.length>0){var t=e[0].getAttribute("index");if(t==indexPlaying)return;playList.splice(t,1),t<indexPlaying&&indexPlaying--,displayPlayList()}}function addToPlaylist(e){for(var t=e.files,a=0;a<t.length;a++){for(var n=!1,l=0;l<playList.length;l++)if(playList[l].name==t[a].name){n=!0;break}0==n&&playList.push(t[a])}displayPlayList()}function displayPlayList(){var e=document.getElementById("playlistRing");e.innerHTML="";for(var t=0;t<playList.length;t++){var a=document.createElement("div"),n=new String(playList[t].name);a.innerHTML=n.substring(0,n.indexOf(".")),a.className="songItem",a.style.top=20*t+5+"px",a.setAttribute("index",t),a.onclick=function(){document.getElementsByClassName("songItemFocused").length>0&&document.getElementsByClassName("songItemFocused")[0].classList.remove("songItemFocused"),this.classList.add("songItemFocused")},e.appendChild(a)}focusNowPlaying()}function next(){if(playList[indexPlaying+1])return window.cancelAnimationFrame(requestAnimId),requestAnimId=void 0,void playAudio()}function previous(){if(playList[indexPlaying-1])return window.cancelAnimationFrame(requestAnimId),requestAnimId=void 0,indexPlaying-=2,void playAudio()}function presetChanged(e){audio&&(document.getElementsByClassName("focusedBtn")[0].classList.remove("focusedBtn"),e.classList.add("focusedBtn"),"dance"==e.id&&(equalizer80Hz.gain.value=8.12,equalizer240Hz.gain.value=3.53,equalizer750Hz.gain.value=.35,equalizer2200Hz.gain.value=-.35,equalizer6000Hz.gain.value=2.18,document.getElementById("80").value=8.12,document.getElementById("240").value=3.53,document.getElementById("750").value=.35,document.getElementById("2200").value=-.35,document.getElementById("6000").value=2.18),"powerful"==e.id&&(equalizer80Hz.gain.value=10.97,equalizer240Hz.gain.value=3.56,equalizer750Hz.gain.value=-.5,equalizer2200Hz.gain.value=3.39,equalizer6000Hz.gain.value=10.97,document.getElementById("80").value=10.97,document.getElementById("240").value=3.56,document.getElementById("750").value=-.5,document.getElementById("2200").value=3.39,document.getElementById("6000").value=10.97),"live"==e.id&&(equalizer80Hz.gain.value=-18,equalizer240Hz.gain.value=-3.88,equalizer750Hz.gain.value=6.68,equalizer2200Hz.gain.value=4.44,equalizer6000Hz.gain.value=5.97,document.getElementById("80").value=-18,document.getElementById("240").value=-3.88,document.getElementById("750").value=6.68,document.getElementById("2200").value=4.44,document.getElementById("6000").value=5.97),"soft"==e.id&&(equalizer80Hz.gain.value=-8.26,equalizer240Hz.gain.value=-7.56,equalizer750Hz.gain.value=-10.38,equalizer2200Hz.gain.value=7.97,equalizer6000Hz.gain.value=12.92,document.getElementById("80").value=-8.26,document.getElementById("240").value=-7.56,document.getElementById("750").value=-10.38,document.getElementById("2200").value=7.97,document.getElementById("6000").value=12.92),"flat"==e.id&&(equalizer80Hz.gain.value=0,equalizer240Hz.gain.value=0,equalizer750Hz.gain.value=0,equalizer2200Hz.gain.value=0,equalizer6000Hz.gain.value=0,document.getElementById("80").value=0,document.getElementById("240").value=0,document.getElementById("750").value=0,document.getElementById("2200").value=0,document.getElementById("6000").value=0))}function pauseAudio(){audio&&(audio.pause(),document.getElementsByClassName("focus")[0].classList.remove("focus"),document.getElementById("pause").classList.add("focus"),audio_paused_stopped=!0)}function playAudio(){setUpAudioContext(),playList.length>0&&(1==audio_paused_stopped?(1==playList.length?loadSong(window.URL.createObjectURL(playList[indexPlaying])):audio.play(),document.getElementsByClassName("focus")[0].classList.remove("focus"),document.getElementById("play").classList.add("focus"),audio_paused_stopped=!1):(indexPlaying++,document.getElementsByClassName("focus")[0].classList.remove("focus"),document.getElementById("play").classList.add("focus"),loadSong(window.URL.createObjectURL(playList[indexPlaying])),focusNowPlaying()))}function focusNowPlaying(){document.getElementsByClassName("playingSong").length>0&&document.getElementsByClassName("playingSong")[0].classList.remove("playingSong"),document.getElementsByClassName("songItem")[indexPlaying]&&(document.getElementsByClassName("songItem")[indexPlaying].classList.add("playingSong"),document.getElementById("trackNameValue").innerHTML=playList[indexPlaying].name)}function stopAudio(){audio&&(audio.pause(),audio.currentTime=0,document.getElementsByClassName("focus")[0].classList.remove("focus"),document.getElementById("stop").classList.add("focus"),audio_paused_stopped=!0)}function eqValueChange(e){80==e.id&&(console.log("80: "+e.value),equalizer80Hz.gain.value=e.value),240==e.id&&(console.log("240: "+e.value),equalizer240Hz.gain.value=e.value),750==e.id&&(console.log("750: "+e.value),equalizer750Hz.gain.value=e.value),2200==e.id&&(console.log("2200: "+e.value),equalizer2200Hz.gain.value=e.value),6e3==e.id&&(console.log("6000: "+e.value),equalizer6000Hz.gain.value=e.value)}String.prototype.getFormattedTime=function(){var e=parseInt(this,10),t=Math.floor(e/3600),a=Math.floor((e-3600*t)/60),n=e-3600*t-60*a;return t<10&&(t="0"+t),a<10&&(a="0"+a),n<10&&(n="0"+n),a+":"+n};
