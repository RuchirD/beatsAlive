function loadSong(e){if(audio)audio.remove();if(sourceNode)sourceNode.disconnect();audio=new Audio;audio.src=e;audio.volume=document.getElementById("vol").value;audio.addEventListener("canplay",function(e){setupAudioNodes()},false)}function initEQFilters(){equalizer80Hz=context.createBiquadFilter();equalizer80Hz.type=5;equalizer80Hz.gain.value=0;equalizer80Hz.Q.value=1;equalizer80Hz.frequency.value=80;equalizer240Hz=context.createBiquadFilter();equalizer240Hz.type=5;equalizer240Hz.gain.value=0;equalizer240Hz.Q.value=1;equalizer240Hz.frequency.value=240;equalizer750Hz=context.createBiquadFilter();equalizer750Hz.type=5;equalizer750Hz.gain.value=0;equalizer750Hz.Q.value=1;equalizer750Hz.frequency.value=750;equalizer2200Hz=context.createBiquadFilter();equalizer2200Hz.type=5;equalizer2200Hz.gain.value=0;equalizer2200Hz.Q.value=1;equalizer2200Hz.frequency.value=2200;equalizer6000Hz=context.createBiquadFilter();equalizer6000Hz.type=5;equalizer6000Hz.gain.value=0;equalizer6000Hz.Q.value=1;equalizer6000Hz.frequency.value=6e3;eqInitiated=true}function setupAudioNodes(){analyser=analyser||context.createAnalyser();source=context.createBufferSource();analyser.smoothingTimeConstant=.8;analyser.fftSize=512;gainNode=context.createGainNode();gainNode.gain.value=1;try{sourceNode=context.createMediaElementSource(audio)}catch(e){return}if(eqInitiated==false)initEQFilters();sourceNode.connect(gainNode);gainNode.connect(equalizer80Hz);equalizer80Hz.connect(equalizer240Hz);equalizer240Hz.connect(equalizer750Hz);equalizer750Hz.connect(equalizer2200Hz);equalizer2200Hz.connect(equalizer6000Hz);equalizer6000Hz.connect(context.destination);sourceNode.connect(analyser);sourceNode.connect(context.destination);audio.play();document.getElementById("play").classList.add("focus");createSpectrum()}function createSpectrum(){if(document.getElementById("rectSVG")){document.getElementById("rectSVG").parentNode.removeChild(document.getElementById("rectSVG"))}rectSVG=d3.select("body").append("svg").attr("width","150%").attr("height","40%").attr("id","rectSVG");var e=[];for(var t=0;t<256;t++){e[e.length]=0}var n=rectSVG.selectAll("rect").data(e);n.enter().append("rect").attr("y",100).attr("x",function(e,t){return t*40}).attr("height",function(e,t){return e}).attr("width",20).style("fill","steelblue");n.exit().remove();document.getElementById("progress").setAttribute("max",audio.duration);drawSpectrum();progressTimer=setInterval("trackChange();",100)}function getArrayAndFillSVG(e){var t=new Uint8Array(analyser.frequencyBinCount);analyser.getByteFrequencyData(t);if(e==0){for(var n=0;n<256;n++){t[n]=0}}var r=rectSVG.selectAll("rect").data(t);r.transition().duration(0).attr("y",100).attr("x",function(e,t){return t*20}).attr("height",function(e,t){return e*1}).attr("width",13).style("fill",function(e,t){if(t<20)return"url(#red)";if(t<40)return"url(#yellow)";if(t<60)return"url(#blue)";if(t<80)return"url(#pink)";else return"url(#grad2)"})}function drawSpectrum(){if(audio.currentTime>=audio.duration){if(playList[indexPlaying+1]){getArrayAndFillSVG(0);playAudio();return}else{if(repeat==true){getArrayAndFillSVG(0);indexPlaying=-1;playAudio()}else{clearInterval(progressTimer);audioOver=true;getArrayAndFillSVG(0);return}}}audioOver=false;getArrayAndFillSVG();requestAnimId=requestAnimationFrame(drawSpectrum)}function volumeChange(e){audio.volume=document.getElementById("vol").value}function highPass(e){var t=document.getElementById("highPassCheck").checked;if(t==true){highPassFilter=context.createBiquadFilter();sourceNode.connect(highPassFilter);highPassFilter.connect(context.destination);highPassFilter.type=0;highPassFilter.frequency.value=800}else{highPassFilter.disconnect(0)}}function lowPass(e){var t=document.getElementById("lowPassCheck").checked;if(t==true){lowPassFilter=context.createBiquadFilter();sourceNode.connect(lowPassFilter);lowPassFilter.connect(context.destination);lowPassFilter.type=1;lowPassFilter.frequency.value=1200}else{lowPassFilter.disconnect(0)}}function gainChange(){if(gainFilter){gainFilter.disconnect(0)}gainFilter=context.createBiquadFilter();gainFilter.type=3;gainFilter.frequency.value=440;gainFilter.gain.value=document.getElementById("gain").value;sourceNode.connect(gainFilter);gainFilter.connect(context.destination)}function toggleMute(){if(audio){var e=audio.volume;if(e==0){audio.volume=storedVol;document.getElementById("volumeIcon").src="Images/Volume.png";document.getElementById("vol").style.opacity=1;document.getElementById("vol").removeAttribute("disabled")}else{storedVol=audio.volume;audio.volume=0;document.getElementById("volumeIcon").src="Images/mute.png";document.getElementById("vol").style.opacity=.4;document.getElementById("vol").setAttribute("disabled","disabled")}}}function toggleRepeat(){if(repeat==true){repeat=false;document.getElementById("repeatIcon").src="Images/repeatOff.png"}else{repeat=true;document.getElementById("repeatIcon").src="Images/repeat.png"}}function trackChange(){document.getElementById("progress").value=audio.currentTime;document.getElementById("progressTime").innerHTML=audio.currentTime.toString().getFormattedTime()+"/"+audio.duration.toString().getFormattedTime()}function progressChange(){clearInterval(progressTimer);audio.currentTime=document.getElementById("progress").value;progressTimer=setInterval("trackChange();",100)}function audioChange(e){var t=e.files;if(t.length>0){var n=window.URL.createObjectURL(t[0]);if(document.getElementById("rectSVG")){document.getElementById("rectSVG").parentNode.removeChild(document.getElementById("rectSVG"))}document.getElementById("trackNameValue").innerHTML="::: Now Playing ::: "+t[0].name;loadSong(n);document.getElementsByClassName("focus")[0].classList.remove("focus")}}function removeFromPlayList(){var e=document.getElementsByClassName("songItemFocused");if(e.length>0){var t=e[0].getAttribute("index");if(t==indexPlaying){return}else{playList.splice(t,1);if(t<indexPlaying)indexPlaying--;displayPlayList()}}}function addToPlaylist(e){var t=e.files;for(var n=0;n<t.length;n++){var r=false;for(var i=0;i<playList.length;i++){if(playList[i].name==t[n].name){r=true;break}}if(r==false){playList.push(t[n])}}displayPlayList()}function displayPlayList(){var e=document.getElementById("playlistRing");e.innerHTML="";for(var t=0;t<playList.length;t++){var n=document.createElement("div");var r=new String(playList[t].name);n.innerHTML=r.substring(0,r.indexOf("."));n.className="songItem";n.style.top=t*20+5+"px";n.setAttribute("index",t);n.onclick=function(){if(document.getElementsByClassName("songItemFocused").length>0)document.getElementsByClassName("songItemFocused")[0].classList.remove("songItemFocused");this.classList.add("songItemFocused")};e.appendChild(n)}focusNowPlaying()}function next(){if(playList[indexPlaying+1]){window.cancelAnimationFrame(requestAnimId);requestAnimId=undefined;playAudio();return}}function previous(){if(playList[indexPlaying-1]){window.cancelAnimationFrame(requestAnimId);requestAnimId=undefined;indexPlaying=indexPlaying-2;playAudio();return}}function presetChanged(e){if(audio){document.getElementsByClassName("focusedBtn")[0].classList.remove("focusedBtn");e.classList.add("focusedBtn");if(e.id=="dance"){equalizer80Hz.gain.value=8.12;equalizer240Hz.gain.value=3.53;equalizer750Hz.gain.value=.35;equalizer2200Hz.gain.value=-.35;equalizer6000Hz.gain.value=2.18;document.getElementById("80").value=8.12;document.getElementById("240").value=3.53;document.getElementById("750").value=.35;document.getElementById("2200").value=-.35;document.getElementById("6000").value=2.18}if(e.id=="powerful"){equalizer80Hz.gain.value=10.97;equalizer240Hz.gain.value=3.56;equalizer750Hz.gain.value=-.5;equalizer2200Hz.gain.value=3.39;equalizer6000Hz.gain.value=10.97;document.getElementById("80").value=10.97;document.getElementById("240").value=3.56;document.getElementById("750").value=-.5;document.getElementById("2200").value=3.39;document.getElementById("6000").value=10.97}if(e.id=="live"){equalizer80Hz.gain.value=-18;equalizer240Hz.gain.value=-3.88;equalizer750Hz.gain.value=6.68;equalizer2200Hz.gain.value=4.44;equalizer6000Hz.gain.value=5.97;document.getElementById("80").value=-18;document.getElementById("240").value=-3.88;document.getElementById("750").value=6.68;document.getElementById("2200").value=4.44;document.getElementById("6000").value=5.97}if(e.id=="soft"){equalizer80Hz.gain.value=-8.26;equalizer240Hz.gain.value=-7.56;equalizer750Hz.gain.value=-10.38;equalizer2200Hz.gain.value=7.97;equalizer6000Hz.gain.value=12.92;document.getElementById("80").value=-8.26;document.getElementById("240").value=-7.56;document.getElementById("750").value=-10.38;document.getElementById("2200").value=7.97;document.getElementById("6000").value=12.92}if(e.id=="flat"){equalizer80Hz.gain.value=0;equalizer240Hz.gain.value=0;equalizer750Hz.gain.value=0;equalizer2200Hz.gain.value=0;equalizer6000Hz.gain.value=0;document.getElementById("80").value=0;document.getElementById("240").value=0;document.getElementById("750").value=0;document.getElementById("2200").value=0;document.getElementById("6000").value=0}}}function pauseAudio(){if(audio){audio.pause();document.getElementsByClassName("focus")[0].classList.remove("focus");document.getElementById("pause").classList.add("focus");audio_paused_stopped=true}}function playAudio(){if(playList.length>0){if(audio_paused_stopped==true){if(playList.length==1)loadSong(window.URL.createObjectURL(playList[indexPlaying]));else audio.play();document.getElementsByClassName("focus")[0].classList.remove("focus");document.getElementById("play").classList.add("focus");audio_paused_stopped=false}else{indexPlaying++;document.getElementsByClassName("focus")[0].classList.remove("focus");document.getElementById("play").classList.add("focus");loadSong(window.URL.createObjectURL(playList[indexPlaying]));focusNowPlaying()}}}function focusNowPlaying(){if(document.getElementsByClassName("playingSong").length>0)document.getElementsByClassName("playingSong")[0].classList.remove("playingSong");if(document.getElementsByClassName("songItem")[indexPlaying]){document.getElementsByClassName("songItem")[indexPlaying].classList.add("playingSong");document.getElementById("trackNameValue").innerHTML=playList[indexPlaying].name}}function stopAudio(){if(audio){audio.pause();audio.currentTime=0;document.getElementsByClassName("focus")[0].classList.remove("focus");document.getElementById("stop").classList.add("focus");audio_paused_stopped=true}}function eqValueChange(e){if(e.id==80){console.log("80: "+e.value);equalizer80Hz.gain.value=e.value}if(e.id==240){console.log("240: "+e.value);equalizer240Hz.gain.value=e.value}if(e.id==750){console.log("750: "+e.value);equalizer750Hz.gain.value=e.value}if(e.id==2200){console.log("2200: "+e.value);equalizer2200Hz.gain.value=e.value}if(e.id==6e3){console.log("6000: "+e.value);equalizer6000Hz.gain.value=e.value}}var context=new webkitAudioContext;var audioAnimation,audioBuffer,source,sourceNode,analyser,audio,rectSVG,highPassFilter,lowPassFilter,gainFilter,storedVol=1,progressTimer=null,playList=[],indexPlaying=-1,audioOver=false,gainNode=null,equalizer80Hz=null,equalizer240Hz=null,equalizer750Hz=null,equalizer2200Hz=null,equalizer6000Hz=null,eqInitiated=false,requestAnimId=null,repeat=false,audio_paused_stopped=false;String.prototype.getFormattedTime=function(){var e=parseInt(this,10);var t=Math.floor(e/3600);var n=Math.floor((e-t*3600)/60);var r=e-t*3600-n*60;if(t<10){t="0"+t}if(n<10){n="0"+n}if(r<10){r="0"+r}var i=n+":"+r;return i}
